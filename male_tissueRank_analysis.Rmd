---
title: "male_tissueRank_analysis"
output: html_document
date: "2023-10-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load libraries
```{r}
library(plyr)
library(reshape2)
library(dplyr)
library(stringr)
library(readxl)
library(readr)
library(magrittr)
library(ggplot2)
library(edgeR)
library(limma)
library(Glimma)
library(RColorBrewer)

# set project directory
projectDir <- "/Users/taylaalbertini/Desktop/R studio/count_preprocessing/rawData/combinedRaw"
import_mean_male_cpms <- file.path(projectDir, "mean_male_cpms.csv")
gencode_file <- file.path(projectDir, "gencode_v32_gene_id_symbol_chr_biotype.csv")
```

# import data
```{r}
# import mean male cpms data
mean_male_cpms <- read_delim(file = import_mean_male_cpms,
                           col_names = TRUE, 
                          delim = ",") 

# remove the first column - "Sample" no. 
mean_male_cpms <- mean_male_cpms[,-1]

# copy of mean_cpms for subsequent analysis
mean_male_cpms_cp <- as.data.frame(mean_male_cpms)

#gencode
gencode <- read_delim(file = gencode_file,
                       col_names = TRUE,
                       delim = ",") %>%
  as.data.frame()
```

# ranking normalised cpms by male_tissue
```{r}
# make calculate_rank a function 
calculate_rank <- function(x) {
  return(rank(-x))
}

# ranking normalised cpms by female_tissue
mean_male_cpms[, paste0(names(mean_male_cpms)[-1], "_Rank")] <- apply(mean_male_cpms [, -1, drop = FALSE], 2, calculate_rank) 

# create a df selecting just for _Rank  
ranked_male_cpms <- data.frame(mean_male_cpms) %>%
  dplyr::select(matches("_Rank"))
```

# isolating all the instances where placenta is ranked 8th
```{r}
# isolating all instances where placenta ranked 4th in tissue ranking
  ## make samples a column
  ranked_male_cpms <- as.data.frame(ranked_male_cpms) %>%
    tibble::rownames_to_column("Sample")
  ## create a dataframe with geneid in rows and samples in columns
  ranked_male <- t(ranked_male_cpms) %>%
    data.frame() %>%
    tibble::rownames_to_column("geneid")
  ## delete the Sample row
  ranked_male <- ranked_male[-1,]
  ## tidy up the column names
  colnames(ranked_male) <- gsub("X1", "Male_Heart", colnames(ranked_male))
  colnames(ranked_male) <- gsub("X2", "Male_Muscle", colnames(ranked_male))
  colnames(ranked_male) <- gsub("X3", "Male_Placenta", colnames(ranked_male))
  colnames(ranked_male) <- gsub("X4", "Male_Stomach", colnames(ranked_male))
  ## select for the instances where 
  placenta_male_4th <- subset(ranked_male, Male_Placenta == "4")
```

# nCPM > 1 for tissue rank 3
```{r}
# remove "_Rank" from placenta_4th 
# remove placenta column
# convert into long form
rank_comparison_male <- tidyr::separate(placenta_male_4th,col = geneid,into = c("geneid","right")) %>%
  dplyr::select(.,-right) %>%
  dplyr::select(.,-Male_Placenta) %>%
  tidyr::gather(., Tissue, Rank, Male_Heart, Male_Muscle, Male_Stomach)

# nCPMs_female
## remove columns ending in "_Rank"
## create a dataframe with geneid in rows and samples in columns
## removed placenta column
nCPMs_male <- t(mean_male_cpms_cp) %>%
  data.frame() %>%
  tibble::rownames_to_column("geneid") %>%
  dplyr::select(.,-X3)
  ## delete the Sample row
  nCPMs_male <- nCPMs_male[-1,]
  ## tidy up the column names
  colnames(nCPMs_male) <- gsub("X1", "Male_Heart", colnames(nCPMs_male)) 
  colnames(nCPMs_male) <- gsub("X2", "Male_Muscle", colnames(nCPMs_male)) 
  colnames(nCPMs_male) <- gsub("X4", "Male_Stomach", colnames(nCPMs_male)) 

# convert nCPM into long form 
nCPMs_male <- tidyr::gather(nCPMs_male, Tissue, nCPMs, Male_Heart, Male_Muscle, Male_Stomach)  

# left joining the nCPMs_male with rank_comparison
male_analysis <- dplyr::left_join(rank_comparison_male, nCPMs_male, copy = TRUE, by = join_by(geneid, Tissue))

# filter for rows with rank =3 and nCPM = >1
third_rank_male <- male_analysis[male_analysis$Rank == 3 & male_analysis$nCPMs > 1,]
```

# nCPM(rank=3)/nCPM(rank=4) > 3
```{r}
# create df in long form with all genes placenta is ranked 4th in
male_ratio <- tidyr::separate(placenta_male_4th,col = geneid,into = c("geneid","right")) %>%
  dplyr::select(.,-right) %>%
  dplyr::select(.,-c("Male_Heart", "Male_Stomach", "Male_Muscle")) %>%
  tidyr::gather(., Tissue, Rank, Male_Placenta)

# create nCPM 
nCPMs2_male <- t(mean_male_cpms_cp) %>%
  data.frame() %>%
  tibble::rownames_to_column("geneid") %>%
  dplyr::select(.,-c("X1", "X2", "X4"))
  ## delete the Sample row
  nCPMs2_male <- nCPMs2_male[-1,]
  ## tidy up the column names
  colnames(nCPMs2_male) <- gsub("X3", "nCPMs_4", colnames(nCPMs2_male)) 

# left join nCPMs2_male with female_ratio
nCPM4_male_table <- dplyr::left_join(male_ratio, nCPMs2_male, copy = TRUE, by = join_by(geneid))

# left join nCPM3_nCPM4_male_table to third_rank_fulfill by geneid
nCPM3_nCPM4_male_table <- dplyr::left_join(third_rank_male, nCPM4_male_table, copy = TRUE, by = join_by(geneid))

# convert nCPMs and nCPMs_4 to numeric from character
# create a new column nCPM3/nCPM4
nCPM3_nCPM4_male_table$nCPMs_4 <- as.numeric(nCPM3_nCPM4_male_table$nCPMs_4)
nCPM3_nCPM4_male_table$nCPMs <- as.numeric(nCPM3_nCPM4_male_table$nCPMs)
nCPM3_nCPM4_male_table$nCPM_ratio <- nCPM3_nCPM4_male_table$nCPMs / nCPM3_nCPM4_male_table$nCPMs_4

# select for nCPM_ratio > 3
placenta_male_depleted <- nCPM3_nCPM4_male_table[nCPM3_nCPM4_male_table$nCPM_ratio >3,]
```

# left join gene signature with depleted ensembl id
```{r}
# replace geneid with ensembl
colnames(placenta_male_depleted) <- gsub("geneid", "ensembl", colnames(placenta_male_depleted)) 

# left join genecode and placenta_male_depleted
placenta_male_annotated <- dplyr::left_join(placenta_male_depleted, gencode, by = join_by(ensembl))

# tidy up placenta_male_annotated
placenta_male_annotated <- dplyr::select(placenta_male_annotated, -c("Rank.x", "Rank.y"))
```

# export placenta_male_annotated 
```{r}
write.csv(placenta_male_annotated, file = file.path(projectDir, "placenta_male_annotated.csv"))
```

# heat map for depleted male placenta genes
```{r}
library(pheatmap)

# converting mean_tissue_cpms to geneid in rows 
data_male <- t(mean_male_cpms) %>%
  data.frame() %>%
  tibble::rownames_to_column("geneid")
colnames(data_male) <- gsub("X1", "Male Heart", colnames(data_male)) 
  colnames(data_male) <- gsub("X2", "Male Muscle", colnames(data_male)) 
  colnames(data_male) <- gsub("X3", "Male Placenta", colnames(data_male)) 
  colnames(data_male) <- gsub("X4", "Male Stomach", colnames(data_male)) 
    data_male <- data_male[-1,]
    
# make data_male numeric
data_male$`Male Heart` <- as.numeric(data_male$`Male Heart`)
data_male$`Male Muscle` <- as.numeric(data_male$`Male Muscle`)
data_male$`Male Stomach` <- as.numeric(data_male$`Male Stomach`)
data_male$`Male Placenta` <- as.numeric(data_male$`Male Placenta`)

# convert geneid column into rows
data_male_2 <- data_male[,-1]
rownames(data_male_2) <- data_male[,1]

data_2_male_relocate <- dplyr::relocate(data_male_2, `Male Placenta`, .after = `Male Stomach`)

# descending order nCPMs
placenta_male_descending <- placenta_male_annotated %>%
  dplyr::arrange(desc(nCPMs_4)) 

# create heatmap 
pheatmap(log10(data_2_male_relocate[placenta_male_descending$ensembl,] + 0.001),
         cluster_cols = FALSE,
         cluster_rows = FALSE,
         show_rownames = FALSE)
```
# left join descriptions
```{r}
placenta_male_descriptions <- dplyr::left_join(placenta_male_annotated, genes_info, by = join_by(ensembl))
placenta_male_descriptions <- placenta_male_descriptions[,-10]
placenta_male_descriptions <- placenta_male_descriptions[,-10:-15]
placenta_male_descriptions <- placenta_male_descriptions[,-11:-14]
```

# export placenta_male_descriptions
```{r}
write.csv(placenta_male_descriptions, file = file.path(projectDir, "placenta_male_descriptions.csv"))
```
